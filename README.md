# 基于百度OCR的日语文库本扫描实例
[启智协作平台](https://git.openi.org.cn/Thin_Buffalo/OCR-Processing) | [GitHub](https://github.com/ThinBuffalo/BunkoOCR-Prossing)

## 应用场景
将日语文库本自摄照片或扫描图片为原件，用于生成文库本电子文档，以用于机器翻译等场景。

特别考虑到日文书写规范下文库本OCR结果中含有振假名的问题，基于日语文库本的特点进行适配。

## 应用实例
- *《败犬女主太多了！ 9》* 贴吧组翻译（预定）

## 平台支持
- [百度AI开放平台]("https://ai.baidu.com/ai-doc/OCR/dk3iqnq51")

- Node.js语言

## 项目思路介绍
1. 遍历并读取项目根目录`image`文件夹下的照片，分别对每张照片进行处理。（`index.js`）

2. 利用百度AI开放平台的 **通用文字识别（高精度含位置版）** API对图片进行OCR处理（`/script/request.js`）。
    > **建议在OCR前先对拍照件使用扫描服务进行处理。**

    > **已经实现`API Key`和`Secret Key`的封装读取。**
    > 
    > 在根目录下创建`token.json`：
    >
    > ```json
    >   {
    >       "AK": "[填写API Key（`client_id`）]"
    >       "SK": "[填写Secret Key（`client_secret`）]"
    >   }
    > ```

3. 对OCR的结果进行处理，大致清除其中的非正文元素。（`/script/process.js`）

    百度OCR返回的JSON数据大致如下：
    ```JSON
    {
        "words_result" :[
            {
                "words": "[返回的OCR结果]",
                "location": {
                    "top": "[左上顶点的垂直坐标]",
                    "left": "[左上顶点的水平坐标]",
                    "width": "[识别文字宽度]",
                    "height": "[识别文字高度]"
                }
            },
            ...
        ],
        ...
    }
    ```

    分析数据可以发现，正文结果和振假名结果的`width`存在明显差别，扫描件OCR结果的数据尤其明显。例如，正文`width`值分布在50—70左右时，振假名`width`值基本上就在15—20左右分布。只要找到正文`width`值的分布范围，我们就可以较精确地提取正文的扫描结果。

    但需要注意的是，由于各拍摄扫描件拍摄角度、方式等有所不同，这个分布范围并非一个定值，所以需要我们对每张照片`width`值分布进行动态分析。

    另外，在正文和振假名结果之外，意外拍入的书封以及页眉页脚等也会干扰正文获取，这些结果的`width`值一般远大于正文的`width`值。

    1. 正文宽度分布范围的动态分析（`getWidthRange(ocrResult)`）
        
        我们把OCR结果的`width`值排序，并均分成两半分别讨论。
        
        前半部分（`firstHalf`）主要要找到的是振假名宽度的分布范围和正文`width`值的下边界。我们认为，宽度数据从振假名到正文存在“突变”，例如：

        ```
        [..., 23, 23, 23, 23, 24, 25, 47, 50, 50,...]
                                   ^---^
        ```

        在上述数据的`25`和`47`间，就有明显的突变，表现为前后项差值极大。因此，我们可以比较前半部分数据间所有的差值，记录最大的一个差值和它对应的项，以此确定正文`width`值上边界。

        后半部分（`secondHalf`）主要要找到的是书封等异常数据的位置，同时也就确认了正文的下半边界。因为异常数据不一定存在，所以我们更多地倾向于检测有没有过大的差值。因为异常数据通常出现在靠后的位置，我们不妨从后向前倒序遍历，计算后一项与前一项的差值。

        我们这里认为，当这个差值的大小已经达到甚至超过了前一项的二分之一时，就可以认为发生了“突变”。后项和之后的项即可视为数值极大的异常数据，前项即视为正文`width`值的上边界。

        由此，我们就可以确定`width`宽度的分布范围。
    
    2. 正文的提取和返回。根据前一步的函数所取的分布范围，筛选符合标准的OCR结果，并入正文结果（`outputText`）中，最终传回主函数。

4. 主函数将正文结果输出到根目录下的输出文件中（`output.txt`）。（`index.js`）   